@model IEnumerable<AlcaldiaFront.DTOs.EmpleadoDTOs.EmpleadoRespuestaDTo>
@using System.Collections.Generic

@{
    ViewData["Title"] = "Listado de Empleados";
    Dictionary<int, string> municipioNombres = ViewBag.MunicipioNombres as Dictionary<int, string>;
    Dictionary<int, string> cargoNombres = ViewBag.CargoNombres as Dictionary<int, string>;
    int pageSize = 8; // Define cuántos elementos quieres por página
}

<style>
    /* --------------------------------------------------
            PATRÓN DE COLORES FORMAL ADAPTADO (Antracita/Dorado)
            -------------------------------------------------- */
    :root {
        --color-primario: #34495e; /* Azul Marino/Antracita */
        --color-secundario: #f39c12; /* Dorado/Naranja - Acento */
        --color-fondo-claro: #ecf0f1;
        --color-texto: #2c3e50;
        --color-borde: #bdc3c7;
    }

    /* Contenedor principal */
    .data-card-container {
        background-color: var(--color-fondo-claro);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    /* Encabezado principal */
    h1 {
        color: var(--color-primario);
        border-left: 5px solid var(--color-secundario);
        padding-left: 15px;
        margin-bottom: 25px;
    }

    /* Botones de Acción (Crear/Exportar) */
    .btn-primary {
        background-color: var(--color-primario);
        border-color: var(--color-primario);
        transition: background-color 0.3s;
    }

        .btn-primary:hover {
            background-color: #4b6279;
            border-color: #4b6279;
        }

    .btn-secondary-accent {
        background-color: var(--color-secundario);
        border-color: var(--color-secundario);
        color: white;
        transition: opacity 0.3s;
    }

        .btn-secondary-accent:hover {
            opacity: 0.9;
            background-color: var(--color-secundario);
            border-color: var(--color-secundario);
            color: white;
        }

    /* --------------------------------------------------
            ESTILOS DE LA VISTA DE TARJETAS
            -------------------------------------------------- */

    /* Grid para las tarjetas (RESPONSIVE) */
    .employee-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    /* Estilo de la tarjeta individual */
    .employee-card {
        background-color: white;
        border: 1px solid var(--color-borde);
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

    /* Encabezado de la tarjeta */
    .card-header-main {
        background: var(--color-primario);
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        border-bottom: 3px solid var(--color-secundario);
    }

    .employee-avatar {
        background-color: var(--color-secundario);
        color: var(--color-primario);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 15px;
    }

    .employee-name {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
    }

    /* Cuerpo de la tarjeta */
    .card-body-details {
        padding: 15px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.95rem;
        color: var(--color-texto);
    }

        .detail-item i {
            color: var(--color-secundario);
            width: 25px;
            text-align: center;
            margin-right: 8px;
        }

    .badge-estado {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-left: auto;
    }

    .badge-success {
        background-color: #2ecc71; /* Green */
        color: white;
    }

    .badge-danger {
        background-color: #e74c3c; /* Red */
        color: white;
    }

    .badge-secondary {
        background-color: #95a5a6; /* Gray */
        color: white;
    }

    /* Pie de la tarjeta - Acciones */
    .card-footer-actions {
        padding: 15px;
        background-color: var(--color-fondo-claro);
        border-top: 1px solid var(--color-borde);
        display: flex;
        justify-content: space-around;
    }

        .card-footer-actions .btn {
            flex-grow: 1;
            margin: 0 5px;
        }

    /* Paginación */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }

    .page-item .page-link {
        color: var(--color-primario);
        border-color: var(--color-primario);
        transition: background-color 0.3s, color 0.3s;
    }

    .page-item.active .page-link {
        background-color: var(--color-secundario);
        border-color: var(--color-secundario);
        color: white;
        font-weight: bold;
    }

    /* --------------------------------------------------
             * ------------------ ESTILOS DE FILTRO ------------------
             * -------------------------------------------------- */

    .filter-card {
        background-color: var(--color-fondo-claro); /* Gris claro */
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
        transition: all 0.3s;
    }

        .filter-card h5 {
            color: var(--color-primario);
            font-weight: 600;
            margin-bottom: 10px;
        }

    .form-control, .form-select {
        border-radius: 6px;
        border-color: #ccc;
        box-shadow: none;
        transition: border-color 0.3s;
        font-size: 0.95rem;
    }

        .form-control:focus, .form-select:focus {
            border-color: var(--color-secundario);
            box-shadow: 0 0 0 0.1rem rgba(243, 156, 18, 0.5); /* Sombra ligera dorada */
        }

    .btn-filter {
        background-color: var(--color-secundario);
        border-color: var(--color-secundario);
        color: var(--color-primario); /* Texto oscuro en el botón dorado */
        font-weight: 600;
        min-width: 100px;
    }

        .btn-filter:hover {
            background-color: #e6b25a;
            border-color: #e6b25a;
            color: var(--color-primario);
        }

    .btn-clear {
        color: var(--color-primario);
        border-color: #bdc3c7;
    }
</style>

<div class="data-card-container">

    <h1><i class="fas fa-users text-secondary"></i> @ViewData["Title"]</h1>
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">

        @* Botón de Crear Nuevo (a la izquierda) *@
        <a asp-action="Create" class="btn btn-primary mb-2 mb-md-0">
            <i class="fas fa-plus-circle"></i> Crear Nuevo Empleado
        </a>

        @* Botón de Exportar a Excel (a la derecha) *@
        <a asp-controller="Empleado" asp-action="Exportar" class="btn btn-secondary-accent ml-md-2">
            <i class="fas fa-file-excel"></i> Exportar a Excel
        </a>

        <button class="btn btn-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters" aria-expanded="false" aria-controls="collapseFilters">
            <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros
        </button>
    </div>

   
</div>

<div class="collapse" id="collapseFilters">
    <div class="filter-card">
        <form asp-action="Index" method="get">
            <h5><i class="fas fa-search"></i> Filtros de Búsqueda</h5>
            <div class="row g-3">

                <div class="col-md-6 col-lg-3">
                    <label for="NombreEmpleado" class="form-label visually-hidden">Nombre</label>
                    <input type="text"
                           class="form-control"
                           id="NombreEmpleado"
                           name="NombreEmpleado"
                           placeholder="Buscar por Nombre"
                           value="@ViewBag.CurrentNombreEmpleado">
                </div>

                <div class="col-md-6 col-lg-3">
                    <label for="MunicipioId" class="form-label visually-hidden">Municipio</label>
                    <select class="form-select" id="MunicipioId" name="MunicipioId">
                        @foreach (var item in (List<SelectListItem>)ViewBag.MunicipioId)
                        {
                            <option value="@item.Value" selected="@(item.Value == ViewBag.CurrentMunicipioId?.ToString())">@item.Text</option>
                        }
                    </select>
                </div>

                <div class="col-md-6 col-lg-3">
                    <label for="CargoId" class="form-label visually-hidden">Tipo de Documento</label>
                    <select class="form-select" id="CargoId" name="CargoId">
                        @foreach (var item in (List<SelectListItem>)ViewBag.CargoId)
                        {
                            <option value="@item.Value" selected="@(item.Value == ViewBag.CurrentCargoId?.ToString())">@item.Text</option>
                        }
                    </select>
                </div>

                <div class="col-md-6 col-lg-3">
                    <label for="Estado" class="form-label visually-hidden">Estado</label>
                    <select class="form-select" id="Estado" name="Estado">
                        @foreach (var item in (List<SelectListItem>)ViewBag.EstadoList)
                        {
                            <option value="@item.Value" selected="@(item.Value == ViewBag.CurrentEstado)">@item.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-filter me-2"><i class="fas fa-search"></i> Filtrar</button>
                    <a asp-action="Index" class="btn btn-outline-secondary btn-clear"><i class="fas fa-undo"></i> Limpiar Filtros</a>
                </div>
            </div>
        </form>
    </div>
</div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger" role="alert">
            @ViewBag.Error
        </div>
    }

    @if (TempData["Ok"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["Ok"]
        </div>
    }

    @* Inicio del Contenedor de Tarjetas *@
    @if (Model != null && Model.Any())
    {
        <div class="employee-card-grid" id="empleadosCardGrid">
            @foreach (var item in Model)
            {
                var nombreCompleto = $"{item.Nombre} {item.Apellido}";

                string badgeClass = item.Estado?.ToLower() switch
                {
                    "activo" => "badge-success",
                    "inactivo" => "badge-danger",
                    _ => "badge-secondary"
                };

                string nombreCargo = "N/A";
                if (cargoNombres != null && cargoNombres.ContainsKey(item.CargoId))
                {
                    nombreCargo = cargoNombres[item.CargoId];
                }

                string nombreMunicipio = "N/A";
                if (municipioNombres != null && municipioNombres.ContainsKey(item.MunicipioId))
                {
                    nombreMunicipio = municipioNombres[item.MunicipioId];
                }

                <div class="employee-card employee-item">
                    <div class="card-header-main">
                        <div class="employee-avatar">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h2 class="employee-name">@nombreCompleto</h2>
                    </div>

                    <div class="card-body-details">
                        <div class="detail-item">
                            <i class="fas fa-briefcase"></i>
                            <span>Cargo: <strong>@nombreCargo</strong></span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Municipio: @nombreMunicipio</span>
                        </div>
                        <div class="detail-item">
                            <i class="far fa-calendar-alt"></i>
                            <span>Contratación: @item.Fecha_contratacion.ToShortDateString()</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-circle-notch"></i>
                            <span>Estado:</span>
                            <span class="badge-estado @badgeClass">
                                @Html.DisplayFor(modelItem => item.Estado)
                            </span>
                        </div>
                    </div>

                    <div class="card-footer-actions">
                        <a asp-action="Edit" asp-route-id="@item.Id_empleado" class="btn btn-sm btn-outline-primary" title="Editar">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <a asp-action="Details" asp-route-id="@item.Id_empleado" class="btn btn-sm btn-outline-info" title="Detalles">
                            <i class="fas fa-info-circle"></i> Detalles
                        </a>
                        <a asp-action="Delete" asp-route-id="@item.Id_empleado" class="btn btn-sm btn-outline-danger" title="Eliminar">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </a>
                    </div>
                </div>
            }
        </div>

        <nav class="pagination-container" aria-label="Navegación de Empleados">
            <ul class="pagination" id="pagination-ul"></ul>
        </nav>
    }
    else
    {
        <div class="alert alert-info text-center mt-4" role="alert">
            <h4>No hay empleados registrados</h4>
            <p>Comienza creando tu primer empleado.</p>
            <a asp-action="Create" class="btn btn-primary">Crear Primer Empleado</a>
        </div>
    }

</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // --- Configuración de Paginación para Tarjetas ---
            const cardGrid = document.getElementById('empleadosCardGrid');
            if (!cardGrid) return; // Salir si no hay tarjetas

            const rows = Array.from(cardGrid.querySelectorAll('.employee-item'));
            const pageSize = @pageSize;
            const totalPages = Math.ceil(rows.length / pageSize);
            const paginationUl = $('#pagination-ul');

            function displayPage(page) {
                const startIndex = (page - 1) * pageSize;
                const endIndex = startIndex + pageSize;

                rows.forEach((card, index) => {
                    // Ocultar o mostrar la tarjeta según el índice de la página
                    card.style.display = (index >= startIndex && index < endIndex) ? 'block' : 'none';
                });

                updatePaginationControls(page);
            }

            function updatePaginationControls(currentPage) {
                paginationUl.empty(); // Limpiar la paginación existente

                // Botón Anterior
                const prevDisabled = currentPage === 1 ? 'disabled' : '';
                paginationUl.append(`
                    <li class="page-item ${prevDisabled}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}"><i class="fas fa-angle-left"></i> Anterior</a>
                    </li>
                `);

                // Botones de Páginas Numeradas
                // Se muestra un máximo de 5 páginas alrededor de la actual para no saturar
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);

                if (currentPage <= 3) {
                    endPage = Math.min(totalPages, 5);
                }
                if (currentPage > totalPages - 2) {
                    startPage = Math.max(1, totalPages - 4);
                }


                for (let i = startPage; i <= endPage; i++) {
                    const active = i === currentPage ? 'active' : '';
                    paginationUl.append(`
                        <li class="page-item ${active}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `);
                }

                // Botón Siguiente
                const nextDisabled = currentPage === totalPages ? 'disabled' : '';
                paginationUl.append(`
                    <li class="page-item ${nextDisabled}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">Siguiente <i class="fas fa-angle-right"></i></a>
                    </li>
                `);
            }

            // Manejador de clic para los botones de paginación
            paginationUl.on('click', 'a.page-link', function (e) {
                e.preventDefault();
                const newPage = parseInt($(this).data('page'));

                if (!isNaN(newPage) && newPage >= 1 && newPage <= totalPages) {
                    displayPage(newPage);
                    // Desplazar al inicio del contenedor para mejor UX
                    $('html, body').animate({
                        scrollTop: cardGrid.offsetTop - 50
                    }, 300);
                }
            });

            // Inicializar la vista de tarjetas en la página 1
            if (rows.length > 0) {
                displayPage(1);
            }
        });
    </script>
}